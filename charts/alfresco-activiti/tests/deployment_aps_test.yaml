---
suite: test repository manifest
templates:
  - deployment-aps.yaml
  - config-aps.yaml
  - pvc-aps.yaml
tests:
  - it: should have basic metadata in place in deployment & default config
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-aps
        template: deployment-aps.yaml
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: ACTIVITI_DATASOURCE_URL
            valueFrom:
              configMapKeyRef:
                name: RELEASE-NAME-database-aps
                key: DATABASE_URL
        template: deployment-aps.yaml
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: ACTIVITI_DATASOURCE_USERNAME
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-database-secret-aps
                key: DATABASE_USERNAME
        template: deployment-aps.yaml
  - it: should have basic metadata in place in deployment & default config
    set:
      database:
        existingConfigMap:
          name: my-own-custom-config
          keys:
            url: my-own-custom-url
        existingSecret:
          name: my-own-custom-secret
          keys:
            username: my-own-custom-username
            password: my-own-custom-password
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: ACTIVITI_DATASOURCE_URL
            valueFrom:
              configMapKeyRef:
                name: my-own-custom-config
                key: my-own-custom-url
        template: deployment-aps.yaml
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: ACTIVITI_DATASOURCE_USERNAME
            valueFrom:
              secretKeyRef:
                name: my-own-custom-secret
                key: my-own-custom-username
        template: deployment-aps.yaml
  - it: should have a default volume claim when not specifying an existing one
    set:
        persistence.enabled: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].volumeMounts[0].name
          value: data
        template: deployment-aps.yaml
      - equal:
          path: spec.template.spec.containers[0].volumeMounts[0].mountPath
          value: /usr/local/data
        template: deployment-aps.yaml
      - equal:
          path: spec.template.spec.containers[0].volumeMounts[0].subPath
          value: alfresco-process-services/process-data
        template: deployment-aps.yaml
      - equal:
          path: spec.template.spec.volumes[0].persistentVolumeClaim.claimName
          value: aps-default-pvc
        template: deployment-aps.yaml
      - equal:
          path: metadata.name
          value: aps-default-pvc
        template: pvc-aps.yaml
      - isNull:
          path: spec.storageClassName
        template: pvc-aps.yaml
  - it: should set a specific storage class when set
    set:
      persistence.enabled: true
      persistence.storageClass: my-own-storage-class
    asserts:
      - equal:
          path: spec.storageClassName
          value: my-own-storage-class
        template: pvc-aps.yaml
  - it: should override default volume claim when existing claim is provided
    set:
      persistence.enabled: true
      persistence.existingClaim: my-own-custom-pvc
    asserts:
      - isNotEmpty:
          path: spec.template.spec.containers[0].volumeMounts
        template: deployment-aps.yaml
      - equal:
          path: spec.template.spec.volumes[0].persistentVolumeClaim.claimName
          value: my-own-custom-pvc
        template: deployment-aps.yaml
      - hasDocuments:
          count: 0
        template: pvc-aps.yaml
  - it: should not set license by default
    asserts:
      - isEmpty:
          path: spec.template.spec.volumes
        template: deployment-aps.yaml
      - isEmpty:
          path: spec.template.spec.containers[0].volumeMounts
        template: deployment-aps.yaml
  - it: should mount license secret when set
    set:
        license.secretName: my-own-custom-license
    asserts:
      - equal:
          path: spec.template.spec.volumes[0].secret.secretName
          value: my-own-custom-license
        template: deployment-aps.yaml
      - equal:
          path: spec.template.spec.containers[0].volumeMounts[0].name
          value: license
        template: deployment-aps.yaml

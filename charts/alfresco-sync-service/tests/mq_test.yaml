---
suite: test MQ config
templates:
  - secret-message-broker.yaml
tests:
  - it: should render default ActiveMQ crdentials
    values: &testvalues
      - values/test_values.yaml
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-alfresco-sync-mq
      - equal:
          path: data.BROKER_URL
          value: >-
            ZmFpbG92ZXI6KG5pbzovL2FjdGl2ZW1xOjYxNjE2KQ==
      - equal:
          path: data.BROKER_USERNAME
          value: YWRtaW4=
      - equal:
          path: data.BROKER_PASSWORD
          value: YWRtaW4=
  - it: should render custom MQ config from dedicated Values context
    values: *testvalues
    set:
      nameOverride: sync
      messageBroker:
        url: >-
          failover:(ssl://somemoresecuremq-1:61617,ssl://somemoresecuremq-2:61617)
        username: scott
        password: tiger
    asserts:
      - equal:
          path: data.BROKER_URL
          value: >-
            ZmFpbG92ZXI6KHNzbDovL3NvbWVtb3Jlc2VjdXJlbXEtMTo2MTYxNyxzc2w6Ly9zb21lbW9yZXNlY3VyZW1xLTI6NjE2MTcp
      - equal:
          path: data.BROKER_USERNAME
          value: c2NvdHQ=
      - equal:
          path: data.BROKER_PASSWORD
          value: dGlnZXI=
  - it: should not render an MQ secrets
    set:
      messageBroker:
        existingSecret:
          name: mqcreds
    asserts:
      - hasDocuments:
          count: 0

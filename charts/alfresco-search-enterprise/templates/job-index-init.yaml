{{- if .Values.indexInit.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "alfresco-search-enterprise.fullname" . }}-index-init{{ if eq (.Values.indexInit.hookExecution | default "") "post-upgrade" }}-{{ randAlphaNum 5 | lower }}{{ end }}
  labels:
    {{- include "alfresco-search-enterprise.labels" $ | nindent 4 }}
  annotations:
    {{- with .Values.indexInit.hookExecution }}
    "helm.sh/hook": {{ . | quote }}
    {{- end }}
spec:
  ttlSecondsAfterFinished: {{ .Values.indexInit.ttlSecondsAfterFinished }}
  template:
    metadata:
      {{- with .Values.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      labels:
        {{- include "alfresco-search-enterprise.labels" . | nindent 8 }}
    spec:
      serviceAccountName: {{ include "alfresco-search-enterprise.serviceAccountName" . }}
      {{- include "alfresco-common.component-pod-security-context" .Values | indent 4 }}
      {{- include "alfresco-common.imagePullSecrets" . | indent 6 }}
      restartPolicy: {{ .Values.indexInit.restartPolicy }}
      containers:
        - name: {{ .Chart.Name }}-index-init
          image: "{{ .Values.indexInit.image.repository }}:{{ .Values.indexInit.image.tag }}"
          imagePullPolicy: {{ .Values.indexInit.image.pullPolicy }}
          {{- include "alfresco-common.component-security-context" .Values | indent 8 }}
          resources: {{- toYaml .Values.indexInit.resources | nindent 12 }}
          env:
            {{- include "alfresco-search-enterprise.config.spring.envCredentials" $ | nindent 12 }}
            {{- include "alfresco-search-enterprise.config.spring.es.env" $ | nindent 12 }}
            {{- range $key, $val := .Values.indexInit.environment }}
            - name: {{ $key }}
              value: {{ $val | quote }}
            {{- end }}
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -euo pipefail
              echo "Starting index init job"
              ES_URL=$(echo $SPRING_ELASTICSEARCH_REST_URIS | cut -d',' -f1)

              STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" -u "$SPRING_ELASTICSEARCH_REST_USERNAME:$SPRING_ELASTICSEARCH_REST_PASSWORD" "$ES_URL/{{ .Values.indexName }}" || echo "000")

              if [ "$STATUS_CODE" -eq 000 ]; then
                echo "Error: OpenSearch is not reachable at $ES_URL. Exiting."
                exit 1
              fi

              if [ "$STATUS_CODE" -eq 404 ]; then
                echo "Index not found. Creating with shards: {{ .Values.indexInit.numberOfShards }} and replicas: {{ .Values.indexInit.numberOfReplicas }}"
                curl -sSf -X PUT "$ES_URL/{{ .Values.indexName }}" \
                  -H 'Content-Type: application/json' \
                  -u "$SPRING_ELASTICSEARCH_REST_USERNAME:$SPRING_ELASTICSEARCH_REST_PASSWORD" \
                  -d '{
                    "settings": {
                      "index": {
                        "number_of_shards": {{ .Values.indexInit.numberOfShards }},
                        "number_of_replicas": {{ .Values.indexInit.numberOfReplicas }}
                      }
                    }
                  }' || (echo "CRITICAL: Failed to create index." && exit 1)
              elif [ "$STATUS_CODE" -eq 200 ]; then
                echo "Index exists. Enforcing replica count: {{ .Values.indexInit.numberOfReplicas }}"
                curl -sSf -X PUT "$ES_URL/{{ .Values.indexName }}/_settings" \
                  -H 'Content-Type: application/json' \
                  -u "$SPRING_ELASTICSEARCH_REST_USERNAME:$SPRING_ELASTICSEARCH_REST_PASSWORD" \
                  -d '{
                    "index": {
                      "number_of_replicas": {{ .Values.indexInit.numberOfReplicas }}
                    }
                  }' || (echo "Warning: Could not update settings" && exit 1)
              else
                echo "CRITICAL: Unexpected status code $STATUS_CODE received from OpenSearch."
                echo "Please check credentials, permissions, or cluster health."
                exit 1
              fi
          {{- with coalesce .Values.indexInit.extraVolumeMounts $.Values.extraVolumeMounts }}
          volumeMounts:
            {{- toYaml . | nindent 12 }}
          {{- end }}
      {{- with $.Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $.Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $.Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with coalesce .Values.indexInit.extraVolumes $.Values.extraVolumes }}
      volumes:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}

---
suite: test repository default configmap
templates:
  - configmap-repository.yaml
  - configmap-database.yaml
  - configmap-mq.yaml
values: &test_values
  - values/test_values.yaml
tests:
  - it: should have some default properties
    template: configmap-repository.yaml
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-alfresco-opts
      - matchRegex:
          path: data.CATALINA_OPTS
          pattern: |-
            (^\s*|[^\s]\s+)-Ddeployment.method=HELM_CHART($|\s)
      - matchRegex:
          path: data.CATALINA_OPTS
          pattern: |-
            (^\s*|[^\s]\s+)-Ddb.username=\${DATABASE_USERNAME}($|\s)
      - matchRegex:
          path: data.CATALINA_OPTS
          pattern: |-
            (^\s*|[^\s]\s+)-Ddb.password=\${DATABASE_PASSWORD}($|\s)

  - it: should render environment vars
    template: configmap-repository.yaml
    set:
      environment:
        CATALINA_OPTS: >-
          -Dserver.allowWrite=false
          -Dcatalina.base="/opt/tomcat/alternate"
        JAVA_OPTS: >-
          -Xmx32G
    asserts:
      - matchRegex:
          path: data.CATALINA_OPTS
          pattern: |-
            (^\s*|[^\s]\s+)-Dserver.allowWrite=false($|\s)
      - matchRegex:
          path: data.CATALINA_OPTS
          pattern: |-
            (^\s*|[^\s]\s+)-Dcatalina.base="/opt/tomcat/alternate"($|\s)
      - matchRegex:
          path: data.JAVA_OPTS
          pattern: |-
            (^\s*|[^\s]\s+)-Xmx32G($|\s)

  - it: should render MySQL properties
    template: configmap-database.yaml
    asserts:
      - equal:
          path: data.DATABASE_URL
          value: mysql://sandy:secret@myhost1:1111
      - equal:
          path: data.DATABASE_HOST
          value: myhost1
      - equal:
          path: data.DATABASE_PORT
          value: "1111"
      - equal:
          path: data.DATABASE_DRIVER
          value: com.mysql.jdbc.Driver

  - it: should render PostgreSQL properties
    template: configmap-database.yaml
    set:
      configuration:
        db:
          url: postgresql://pghost/alfdb
    asserts:
      - equal:
          path: data.DATABASE_URL
          value: postgresql://pghost/alfdb
      - equal:
          path: data.DATABASE_HOST
          value: pghost
      - equal:
          path: data.DATABASE_PORT
          value: "5432"
      - equal:
          path: data.DATABASE_DRIVER
          value: org.postgresql.Driver

  - it: should render MS SQL server properties
    template: configmap-database.yaml
    set:
      configuration:
        db:
          url: sqlserver://sqlserverhost;databaseName=alfdb;lockTimeout=1000;
    asserts:
      - equal:
          path: data.DATABASE_URL
          value: sqlserver://sqlserverhost;databaseName=alfdb;lockTimeout=1000;
      - equal:
          path: data.DATABASE_HOST
          value: sqlserverhost
      - equal:
          path: data.DATABASE_PORT
          value: "1434"
      - equal:
          path: data.DATABASE_DRIVER
          value: com.microsoft.sqlserver.jdbc.SQLServerDriver

  - it: should render Oracle properties
    template: configmap-database.yaml
    set:
      configuration:
        db:
          url: oracle:thin:@tcp://mydbhost:1521/mydbservice
    asserts:
      - equal:
          path: data.DATABASE_URL
          value: oracle:thin:@tcp://mydbhost:1521/mydbservice
      - equal:
          path: data.DATABASE_HOST
          value: mydbhost
      - equal:
          path: data.DATABASE_PORT
          value: "1521"
      - equal:
          path: data.DATABASE_DRIVER
          value: oracle.jdbc.OracleDriver

  - it: should fail without proper db URL
    template: configmap-repository.yaml
    set:
      configuration:
        db:
          url: jdbc:mysql://myhost/db
    asserts:
      - failedTemplate:
          errorMessage: >-
            database URL MUST be provided WITHOUT the 'jdbc' prefix.

  - it: should render ActiveMQ config as needed
    template: configmap-mq.yaml
    asserts:
      - equal:
          path: data.BROKER_URL
          value: failover:(tcp://localhost:61616)
  - it: should render ActiveMQ minimal config
    template: configmap-mq.yaml
    set:
      configuration:
        messageBroker:
          url: ssl://amqs:61617
    asserts:
      - equal:
          path: data.BROKER_URL
          value: failover:(ssl://amqs:61617)
  - it: should NOT render configmaps
    set:
      configuration:
        db:
          existingConfigMap:
            name: mydbcm
        messageBroker:
          existingConfigMap:
            name: mymqcm
    asserts:
      - hasDocuments:
          count: 0
        template: configmap-database.yaml
      - hasDocuments:
          count: 0
        template: configmap-mq.yaml

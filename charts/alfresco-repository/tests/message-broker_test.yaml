---
suite: test Message Queue Broker
templates:
  - secret-message-broker.yaml
  - deployment.yaml
  - configmap.yaml
values:
  - values/test_values.yaml
tests:
  - it: should render ActiveMQ minimal config
    asserts:
      - matchRegex:
          path: data.CATALINA_OPTS
          pattern: |-
            (^\s*|[^\s]\s+)-Dmessaging.broker.url="failover:\(tcp://localhost:61616\)"($|\s)
        template: configmap.yaml
      - equal:
          path: spec.template.metadata.annotations['checksum.config.alfresco.org/messageBroker']
          value: &cfgsum c2939932894f879e156e0ccaebb43552058663dbbedd75c74afd20a86662e054
        template: deployment.yaml

  - it: should render custom secret with modified checksum
    set:
      configuration:
        messageBroker:
          existingSecret:
            name: mqSecret
            keys:
              username: mquser
              password: mqpass
          url: ssl://amqs:61617
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: BROKER_USERNAME
            valueFrom:
              secretKeyRef:
                name: mqSecret
                key: mquser
                optional: true
        template: deployment.yaml
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: BROKER_PASSWORD
            valueFrom:
              secretKeyRef:
                name: mqSecret
                key: mqpass
                optional: true
        template: deployment.yaml
      - matchRegex:
          path: data.CATALINA_OPTS
          pattern: |-
            (^\s*|[^\s]\s+)-Dmessaging.broker.url="failover:\(ssl://amqs:61617\)"($|\s)
        template: configmap.yaml
      - hasDocuments:
          count: 0
        template: secret-message-broker.yaml
      - notEqual:
          path: spec.template.metadata.annotations['checksum.config.alfresco.org/db']
          value: *cfgsum
        template: deployment.yaml

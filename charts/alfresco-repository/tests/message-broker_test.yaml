---
suite: test Message Queue Broker
templates:
  - secret-message-broker.yaml
  - deployment.yaml
  - configmap-message-broker.yaml
values:
  - values/test_values.yaml
tests:
  - it: should render ActiveMQ minimal config
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: BROKER_URL
            valueFrom:
              configMapKeyRef:
                name: RELEASE-NAME-configmap-mq
                key: BROKER_URL
        template: deployment.yaml
      - equal:
          path: data.BROKER_URL
          value: failover:(tcp://localhost:61616)
        template: configmap-message-broker.yaml
      - equal:
          path: spec.template.metadata.annotations['checksum.config.alfresco.org/messageBroker']
          value: &cfgsum c2939932894f879e156e0ccaebb43552058663dbbedd75c74afd20a86662e054
        template: deployment.yaml

  - it: should render custom secret with modified checksum
    set:
      configuration:
        messageBroker:
          existingSecret:
            name: mqSecret
            keys:
              username: mquser
              password: mqpass
          existingConfigMap:
            name: mqConfigmap
            keys:
              url: myurl
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: BROKER_URL
            valueFrom:
              configMapKeyRef:
                name: mqConfigmap
                key: myurl
        template: deployment.yaml
      - hasDocuments:
          count: 0
        template: secret-message-broker.yaml
      - notEqual:
          path: spec.template.metadata.annotations['checksum.config.alfresco.org/db']
          value: *cfgsum
        template: deployment.yaml

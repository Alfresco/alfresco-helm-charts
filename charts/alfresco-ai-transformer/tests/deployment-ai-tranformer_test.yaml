suite: test ai-transformer deployment
templates:
- deployment-ai-transformer.yaml
- config-ai-transformer.yaml
tests:
- it: should have basic deployment properties by default
  values: &testvalues
  - values/test_values.yaml
  template: deployment-ai-transformer.yaml
  asserts:
    - contains:
        path: spec.template.spec.containers[0].env
        content:
          name: AWS_ACCESS_KEY_ID
          valuesFrom:
            secretKeyRef:
              name: RELEASE-NAME-aws
              key: AWS_ACCESS_KEY_ID
    - contains:
        path: spec.template.spec.containers[0].env
        content:
          name: AWS_SECRET_ACCESS_KEY
          valuesFrom:
            secretKeyRef:
              name: RELEASE-NAME-aws
              key: AWS_SECRET_ACCESS_KEY
    - contains:
        path: spec.template.spec.containers[0].env
        content:
          name: FILE_STORE_URL
          valuesFrom:
            configMapKeyRef:
              name: RELEASE-NAME-alfresco-ai-transformer
              key: FILE_STORE_URL
    - contains:
        path: spec.template.spec.containers[0].env
        content:
          name: AWS_REGION
          valuesFrom:
            configMapKeyRef:
              name: RELEASE-NAME-aws
              key: AWS_REGION
    - contains:
        path: spec.template.spec.containers[0].env
        content:
          name: AWS_S3_BUCKET
          valuesFrom:
            configMapKeyRef:
              name: RELEASE-NAME-aws
              key: AWS_S3_BUCKET
    - contains:
        path: spec.template.spec.containers[0].env
        content:
          name: AWS_COMPREHEND_ROLE_ARN
          valuesFrom:
            configMapKeyRef:
              name: RELEASE-NAME-aws
              key: AWS_COMPREHEND_ROLE_ARN
    - isSubset:
        path: metadata.labels
        content:
          app.kubernetes.io/component: alfresco-ai-transformer
    - equal:
        path: spec.template.spec.serviceAccountName
        value: ai-transformer-sa
    - equal:
        path: metadata.name
        value: RELEASE-NAME-alfresco-ai-transformer
    - equal:
        path: metadata.name
        value: RELEASE-NAME-alfresco-ai-transformer
    - equal:
        path: spec.template.spec.containers[0].resources
        value:
          requests:
            cpu: "0.25"
            memory: "1000Mi"
          limits:
            cpu: "2"
            memory: "1000Mi"
- it: should have basic metadata in place
  values: *testvalues
  set:
    serviceAccount:
      create: false
      name: null
  template: deployment-ai-transformer.yaml
  asserts:
    - equal:
        path: spec.template.spec.serviceAccountName
        value: default

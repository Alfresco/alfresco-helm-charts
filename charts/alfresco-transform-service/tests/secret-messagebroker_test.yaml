---
suite: test activemq secret
templates:
  - secret-messagebroker.yaml

tests:
  - it: should render a secret with provided credentials
    values: &testvalues
      - values/test_values.yaml
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-messagebroker-secret
      - equal:
          path: data.BROKER_URL
          value: failover:(nio://activemq-broker:61616)?timeout=3000&jms.useCompression=true
          decodeBase64: true
        template: secret-messagebroker.yaml
      - equal:
          path: data.BROKER_USERNAME
          value: alfresco
          decodeBase64: true
        template: secret-messagebroker.yaml
      - equal:
          path: data.BROKER_PASSWORD
          value: somesecret
          decodeBase64: true
        template: secret-messagebroker.yaml

  - it: should fail without url
    values: &testvalues
      - values/test_values.yaml
    set:
      messageBroker:
        url: null
    asserts:
      - failedTemplate:
          errorMessage: Disabling in-cluster ActiveMQ requires passing (at least) messageBroker.url

  - it: should not render a secret when existing secret is provided
    values: *testvalues
    set:
      messageBroker:
        existingSecret:
          name: mysecretname
    asserts:
      - hasDocuments:
          count: 0
        template: secret-messagebroker.yaml
